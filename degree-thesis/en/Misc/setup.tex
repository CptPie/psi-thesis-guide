%----------------------------------------------------------------------------------------
%		UNIVERSITY OF BAMBERG COLORS
%----------------------------------------------------------------------------------------

% http://www.brandwares.com/RGBTintCalculator.php
% Base Color value obtained from UB Corporate Identity Manual 
\definecolor{ubblue}{HTML}{00457D}
\definecolor{ubblue80}{HTML}{336A97}
\definecolor{ubblue60}{HTML}{668FB1}
\definecolor{ubblue40}{HTML}{99B5CB}
\definecolor{ubblue20}{HTML}{CCDAE5}


%----------------------------------------------------------------------------------------
%		FONT SETUP
%----------------------------------------------------------------------------------------

\usepackage[T1]{fontenc} % Output font encoding for international characters

\usepackage{fontspec}

\setmainfont[
	Path           = fonts/,
    BoldFont       = {Crimson-Semibold.otf},
    ItalicFont     = {Crimson-Italic.otf},
    BoldItalicFont = {Crimson-BoldItalic.otf}
]{Crimson-Roman.otf}


\usepackage[p,osf]{cochineal}
 
\AtBeginEnvironment{tabular}{%
  \tlfstyle
}


\setmonofont[
	Path           = fonts/,
    BoldFont       = {UbuntuMono-B.ttf},
    ItalicFont       = {UbuntuMono-RI.ttf},
    BoldItalicFont       = {UbuntuMono-BI.ttf},
    Scale = MatchLowercase
]{UbuntuMono-R.ttf}

%\newfontfamily\headingfont[
%	Path          	= fonts/,
%	BoldFont		= Roboto-Bold.otf,
%	ItalicFont		= Roboto-Italic.otf,
%	BoldItalicFont	= Roboto-BoldItalic.otf
%]{Roboto-Regular.otf}


\setsansfont[
	Path          	= fonts/,
	BoldFont		= Roboto-Bold.otf,
	ItalicFont		= Roboto-Italic.otf,
	BoldItalicFont	= Roboto-BoldItalic.otf
]{Roboto-Regular.otf}

\renewcommand{\familydefault}{\rmdefault}
\defaultfontfeatures{Ligatures=TeX}

\usepackage[cochineal,vvarbb]{newtxmath}
\usepackage[cal=boondoxo]{mathalfa}


%----------------------------------------------------------------------------------------
%		TITLE SETUP
%----------------------------------------------------------------------------------------

\usepackage[explicit]{titlesec}

\definecolor{gray75}{gray}{0.75}
\newcommand{\hsp}{\hspace{20pt}}



% ====== replace Q with \Qswash in Chapters and Sections =========

\newcommand{\swashedletter}{\Qswash}
\catcode`Q=\active
\defQ{\swashedletter}
\catcode`Q=11
\usepackage{xstring}
\noexpandarg\exploregroups
\newcommand\ReplaceStrQ[1]{\StrSubstitute{#1}{Q}{\swashedletter}}

% ================================================================



\titleformat{\chapter}[hang]{\Huge\bfseries}{\color{ubblue60}\thechapter}{20pt}{\begin{tabular}[t]{@{\color{ubblue60}\vrule width 2pt\hsp}p{0.85\textwidth}}\raggedright\ReplaceStrQ{#1}\end{tabular}}

\titleformat{\section}[hang]{\bfseries\large}{{\color{ubblue80}\arabic{chapter}.\arabic{section}}}{1ex}{{\color{ubblue80}\ReplaceStrQ{#1}}}{}

\titleformat{\subsection}[hang]{\bfseries\large}{{\color{ubblue80}\arabic{chapter}.\arabic{section}.\arabic{subsection}}}{1ex}{{\color{ubblue80}\ReplaceStrQ{#1}}}{}

\titleformat{\subsubsection}[hang]{\bfseries}{{\color{ubblue80}\arabic{chapter}.\arabic{section}.\arabic{subsection}.\arabic{subsubsection}}}{1ex}{{\color{ubblue80}\ReplaceStrQ{#1}}}{}


\titlespacing*{\section}
{0pt}{7ex}{3ex}

\titlespacing*{\subsection}
{0pt}{4ex}{2ex}

\titlespacing*{\subsubsection}
{0pt}{4ex}{2ex}


%----------------------------------------------------------------------------------------
%		TABLE OF CONTENTS SETUP
%----------------------------------------------------------------------------------------

\usepackage{tocloft}

% Recommendation is to use 1 or 2
%\setcounter{tocdepth}{1}

% recommended if you have tocdepth > 1
%\usepackage{tocloft}
%\setlength{\cftbeforesecskip}{6pt}

%\usepackage{textcase}
%\makeatletter
%\DeclareRobustCommand{\spacedallcaps}[1]{\textsc{\textls[160]{\MakeTextUppercase{#1}}}} \DeclareRobustCommand{\spacedlowsmallcaps}[1]{\textsc{\textls[80]{\MakeTextLowercase{#1}}}}
%\makeatother
%%%
%%%% ********************************************************************
%%%% layout of the TOC, LOF and LOT (LOL-workaround see next section)
%%%% ********************************************************************
%%%\PassOptionsToPackage{titles}{tocloft}
%%%\RequirePackage{tocloft}
%%%% avoid page numbers being right-aligned in fixed-size box
%%%\newlength{\newnumberwidth}
%%%\settowidth{\newnumberwidth}{999} % yields overfull hbox warnings for pages > 999
%%%\cftsetpnumwidth{\newnumberwidth}
%%%
%%%% have the bib neatly positioned after the rest
%%%\newlength{\beforebibskip}
%%%\setlength{\beforebibskip}{0em}
%%%
%%%
%%%
%%%    \renewcommand{\thepart}{\roman{part}}%
%%%    \renewcommand{\cftpartpresnum}{\scshape}%  \MakeTextLowercase
%%%    \renewcommand{\cftpartaftersnum}{}%
%%%    \renewcommand{\cftpartaftersnumb}{\spacedlowsmallcaps}%
%%%    \setlength{\cftpartnumwidth}{\cftchapnumwidth}
%%%    \renewcommand{\cftpartfont}{\color{CTtitle}\normalfont}%
%%%    \cftpagenumbersoff{part}
%%%    \renewcommand{\cftpartpagefont}{\normalfont}%
%%%    \setlength{\cftbeforepartskip}{1em}%
%%%    \setlength{\cftbeforechapskip}{.1em}%
%%%    \setlength{\beforebibskip}{1.5\cftbeforepartskip}%
%%%
%%%
%%%        \renewcommand{\cftchappresnum}{\spacedlowsmallcaps}%
%%%        \renewcommand{\cftchapaftersnumb}{\spacedlowsmallcaps}%
%%%        \renewcommand{\cftchapfont}{\normalfont}%
%%%        \renewcommand{\cftchappagefont}{\normalfont}%
%%%        %\setlength{\cftbeforechapskip}{.1em}%
%%%
%%%\renewcommand{\cftsecpresnum}{\scshape\MakeTextLowercase}%
%%%\renewcommand{\cftsecfont}{\normalfont}%
%%%\renewcommand{\cftsecpagefont}{\normalfont}%
%%%
%%%% subsections
%%%\renewcommand{\cftsubsecpresnum}{\scshape\MakeTextLowercase}%
%%%\renewcommand{\cftsubsecfont}{\normalfont}%
%%%
%%%% subsubsections
%%%\renewcommand{\cftsubsubsecpresnum}{\scshape\MakeTextLowercase}%
%%%\renewcommand{\cftsubsubsecfont}{\normalfont}%
%%%
%%%% figures
%%%\renewcommand{\cftfigpresnum}{\scshape\MakeTextLowercase}%
%%%\renewcommand{\cftfigfont}{\normalfont}%
%%%
%%%\renewcommand{\cftfigpresnum}{\figurename~}%Fig.~}
%%%\newlength{\figurelabelwidth}
%%%\settowidth{\figurelabelwidth}{\cftfigpresnum~999}
%%%\addtolength{\figurelabelwidth}{2.5em}
%%%\cftsetindents{figure}{0em}{\figurelabelwidth}
%%%
%%%% tables
%%%\renewcommand{\cfttabpresnum}{\scshape\MakeTextLowercase}%
%%%\renewcommand{\cfttabfont}{\normalfont}%
%%%
%%%\renewcommand{\cfttabpresnum}{\tablename~}%Tab.~}
%%%\newlength{\tablelabelwidth}
%%%\settowidth{\tablelabelwidth}{\cfttabpresnum~999}
%%%\addtolength{\tablelabelwidth}{2.5em}
%%%%\cftsetindents{table}{0em}{\tablelabelwidth}
%%%\cftsetindents{table}{0em}{\figurelabelwidth}
%%%
%%%
%%%\AtBeginDocument{\addtocontents{toc}{\protect\vspace{-\cftbeforechapskip}}}
%%%
%%%
%%%\newcommand{\tocEntry}[1]{\protect\numberline {}{#1}}%
%%%
%%%\DeclareRobustCommand*{\deactivateaddvspace}{\let\addvspace\@gobble}%
%%%\AtBeginDocument{%
%%%    \addtocontents{lof}{\deactivateaddvspace}%
%%%    \addtocontents{lot}{\deactivateaddvspace}%
%%%}%
%%%%    }

%%%%% 
%\renewcommand{\cftchappresnum}{\bfseries}%
%\renewcommand{\cftchapaftersnumb}{\bfseries}%
%\renewcommand{\cftchapfont}{\bfseries}%
%\renewcommand{\cftchappagefont}{\bfseries}%
%%\setlength{\cftbeforechapskip}{.1em}%
%
%
%\renewcommand{\cftsecleader}{}
%\setlength{\cftsecindent}{1cm} %  Einzug bei Sections
%\renewcommand{\cftsecafterpnum}{\cftparfillskip}
%\setlength{\cftbeforesecskip}{.4\baselineskip}
%%\setlength{\cftbeforesubsecskip}{.1\baselineskip}
%\renewcommand{\cftsubsecleader}{}
%\setlength{\cftsubsecindent}{2cm} %   Einzug bei Subsections
%\renewcommand{\cftsubsecafterpnum}{\cftparfillskip}
%\setlength{\cftbeforesubsecskip}{.4\baselineskip}
%
%%%% 


%%% https://tex.stackexchange.com/questions/178510/how-can-i-reproduce-this-beautiful-table-of-contents
\usepackage{etoc}
\etocsetlevel{section}{2}
\etocsetlevel{subsection}{3}
\etocsettocdepth{section} % set to subsection for adding subsections to toc (not recommended)

\newlength{\tocleft}
\setlength{\tocleft}{2.5cm} % must be made to fit the inntermargin defined in geometry

\newlength{\tocsep}
\setlength{\tocsep}{2em}

\etocsetstyle{chapter}
   {}
   {}
   {\etocifnumbered
     {\makebox[0pt][r]
       {\chaptername\ \etocnumber\hspace{\tocsep}}%
       \textbf{\etocname\kern1em\relax\etocpage}%
    }%
    {\textbf{\etocname\kern1em\relax\etocpage}}%
    \par\vspace{3ex}%
   }%
   {}

\etocsetstyle{section}
   {\vspace{-2ex}} % Muss von den 3ex aus Chapter abgezogen werden
   {}
   {\makebox[0pt][r]{\etocnumber\hspace{\tocsep}}%
    \etocname\kern1em\etocpage\par%
   }%
   {\addvspace{3ex}} % 3ex falls danach Chapter kommt 

\etocsetstyle{subsection} 
   {\vspace{0ex}} 
   {} 
   {\makebox[3em][l]{\etocnumber}\etocname\kern1em\etocpage\par} 
   {\addvspace{2ex}} % 2ex falls danach Section kommt 

\etocsettocstyle{\chapter*{\contentsname}
                \thispagestyle{plain}%
                \leftskip\tocleft\parindent0pt}{}
%%%



%----------------------------------------------------------------------------------------
%		OTHER PACKAGES
%----------------------------------------------------------------------------------------

\usepackage{marginnote} % Enable Notes on the Page Margin
\usepackage{ragged2e}
\renewcommand*{\raggedleftmarginnote}{\RaggedLeft}
\renewcommand*{\raggedrightmarginnote}{\RaggedRight}
\renewcommand*{\marginfont}{\scriptsize\sffamily\itshape}

\renewcommand{\marginnotevadjust}{0.71\baselineskip}

\usepackage{microtype} % Enable better typographic setup

\usepackage{multicol} % Enable usage of multiple columns

% biblatex setup is inspired by https://anneurai.net/2017/10/18/thesis-formatting-in-latex/
\usepackage[
  backend=biber,
  style=alphabetic,
  doi=false,isbn=false,
  terseinits=true, % no points between initials
  giveninits=true, % always print only initials for given names
  sortcites=true,
  language=english,
  backref=true, % show on what pages a ref has been cited
]{biblatex} % Use biber backend with alphabetic reference style
\AtEveryBibitem{%
  \clearlist{language} % don't show "en."
  \clearlist{extra} % clears extra fields such as ISBN nrs
}

\DefineBibliographyStrings{english}{%
  backrefpage = {page},
  backrefpages = {pages},
}

%-- no "quotes" around titles of chapters/article titles
\DeclareFieldFormat[article, inbook, incollection, inproceedings, misc, thesis, unpublished]{title}{#1}
%-- no punctuation after volume
\DeclareFieldFormat[article]{volume}{{#1}}
%-- puts number/issue between brackets
\DeclareFieldFormat[article, inbook, incollection, inproceedings, misc, thesis, unpublished]{number}{\mkbibparens{#1}}
%-- and then for articles directly the pages w/o any "pages" or "pp."
\DeclareFieldFormat[article]{pages}{#1}
%-- format 16(4):224--225 for articles
\renewbibmacro*{volume+number+eid}{\printfield{volume}\printfield{number}\printunit{\addcolon}
}
\DeclareFieldFormat{url}{\url{#1}}


\usepackage[autostyle=true]{csquotes} % Required to generate language-dependent quotes in the bibliography

\usepackage[
  obeyFinal,
  textsize=scriptsize,
  backgroundcolor=yellow,linecolor=gray75,bordercolor=gray75,
]{todonotes}

\makeatletter
\renewcommand{\todo}[2][]{\@bsphack\@todo[#1]{\sffamily #2}\@esphack\ignorespaces}
\makeatother

\usepackage{booktabs}

\urlstyle{same}

% URL breaking
\PassOptionsToPackage{hyphens}{url}
\expandafter\def\expandafter\UrlBreaks\expandafter{\UrlBreaks% save the current one
  \do\a\do\b\do\c\do\d\do\e\do\f\do\g\do\h\do\i\do\j%
  \do\k\do\l\do\m\do\n\do\o\do\p\do\q\do\r\do\s\do\t%
  \do\u\do\v\do\w\do\x\do\y\do\z\do\A\do\B\do\C\do\D%
  \do\E\do\F\do\G\do\H\do\I\do\J\do\K\do\L\do\M\do\N%
  \do\O\do\P\do\Q\do\R\do\S\do\T\do\U\do\V\do\W\do\X%
  \do\Y\do\Z\do\*\do\-\do\~\do\'\do\"\do\-}%


% hyperlink layout
\usepackage{hyperref}
 \hypersetup{colorlinks,breaklinks,unicode,
             citecolor=ubblue60,
             linkcolor=ubblue60,
             filecolor=ubblue60,
             urlcolor=ubblue60}


% makes links appear in black when print
% (do not use, breaks title page layout)
%\usepackage[ocgcolorlinks]{ocgx2}

% hyperlink for \citeauthor as well
\DeclareCiteCommand{\citeauthor}
  {\boolfalse{citetracker}%
   \boolfalse{pagetracker}%
   \usebibmacro{prenote}}
  {\ifciteindex
     {\indexnames{labelname}}
     {}%
   \printtext[bibhyperref]{\printnames{labelname}}}
  {\multicitedelim}
  {\usebibmacro{postnote}}
 
% https://tex.stackexchange.com/questions/27607/biblatex-authoryear-comp-and-hyperlinks
% make full author-year into hyperlinks, will be colored grey
\makeatletter
\let\abx@macro@citeOrig\abx@macro@cite
\renewbibmacro{cite}{%
   \bibhyperref{%
   \let\bibhyperref\relax\relax%
   \abx@macro@citeOrig%
   }%
}
\let\abx@macro@textciteOrig\abx@macro@textcite
\renewbibmacro{textcite}{%
   \bibhyperref{%
   \let\bibhyperref\relax\relax%
   \abx@macro@textciteOrig%
   }%
}%
\makeatother


\usepackage{cleveref}

\raggedbottom % dont force the same page length by increasing space between paragraphs

%----------------------------------------------------------------------------------------
%	SETUP BIBLIOGRAPHY
%----------------------------------------------------------------------------------------
\setlength{\bibitemsep}{.3\baselineskip plus .05\baselineskip minus .05\baselineskip}
\newlength{\bibparskip}\setlength{\bibparskip}{0pt}
\let\oldthebibliography\thebibliography
\renewcommand\thebibliography[1]{%
  \oldthebibliography{#1}%
  \setlength{\parskip}{\bibitemsep}%
  \setlength{\itemsep}{\bibparskip}%
}

%----------------------------------------------------------------------------------------
%	MARGIN SETTINGS
%----------------------------------------------------------------------------------------

\geometry{
	paper=a4paper, % Change to letterpaper for US letter
	inner=2cm, % Inner margin
	outer=5.8cm, % Outer margin
	marginparwidth=4cm,
	marginparsep=4mm,
	bindingoffset=.5cm, % Binding offset
	top=1.5cm, % Top margin
	bottom=2.5cm, % Bottom margin
	% showframe, % Uncomment to show how the type block is set on the page
}


%----------------------------------------------------------------------------------------
%	SETUP HEADER AND FOOTER
%----------------------------------------------------------------------------------------
\automark[chapter]{chapter}
%\ihead{\textsc{\headmark}}% Inner header - use for Small Caps in header
\ihead{\textup{\headmark}}% Inner header
\ohead[]{\pagemark}% Outer header
\cfoot[\pagemark]{} 
\automark*[section]{}%


%----------------------------------------------------------------------------------------
% 	SET PDF METADATA
%----------------------------------------------------------------------------------------
\AtBeginDocument{
\hypersetup{pdftitle=\ttitle} % Set the PDF's title to your title
\hypersetup{pdfauthor=\authorname} % Set the PDF's author to your name
\hypersetup{pdfkeywords=\keywordnames} % Set the PDF's keywords to your keywords
}

%\hypersetup{colorlinks=false} % uncomment for to change gray links to black links